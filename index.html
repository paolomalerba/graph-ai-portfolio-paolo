<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>EMERGENCY PHC Project – Ukraine – Monthly Report</title>

<!-- Plotly (interactive charts) -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<style>
  body {font-family: Arial, sans-serif; margin: 20px; max-width: 1200px;}
  h1   {text-align: center;}
  .chart {margin-bottom: 60px;}
  .error {color: red;}
</style>
</head>
<body>
<h1>EMERGENCY PHC Project – Ukraine – Monthly Report</h1>

<div id="chart-month"  class="chart"></div>
<div id="chart-gender" class="chart"></div>
<div id="chart-age"    class="chart"></div>
<div id="chart-cond"   class="chart"></div>

<script>
/* -----------------------------------------------------------
   If you ever rename the tab, change “Data” below to match.
   Sheet must be shared as:  Anyone with the link ▸ Viewer
----------------------------------------------------------- */
const API_URL = "https://opensheet.elk.sh/1tIr5xZK1VQwLz_m5ooNx261rjdZcJD-8MeENZ1IYxvU/Data";

const CONDITION_COLS = ["Headache","High Blood Pressure","High blood sugare",
                        "Gastrointestinal symptoms","Respiratory symptoms",
                        "Depressed mood","Insomnia"];

// ---------- helpers ----------
const titleCase = s => s.replace(/\w\S*/g,
      t => t.charAt(0).toUpperCase() + t.substr(1).toLowerCase());
const error = msg => document.body.insertAdjacentHTML(
      "afterbegin", `<p class="error">${msg}</p>`);

// ---------- main ----------
fetch(API_URL)
  .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
  .then(rows => {
      if (!rows.length) { error("Sheet returned no rows."); return; }

      const monthTotals = {}, genderMonth = {}, ageDist = {},
            condCnt = Object.fromEntries(CONDITION_COLS.map(c => [c, 0]));

      rows.forEach(r => {
          const month  = titleCase((r.Month  || "").trim());   if (!month) return;
          const gender = titleCase((r.Gender || "Unknown").trim()) || "Unknown";
          const ageGrp =           (r.Age    || "Unknown").trim()  || "Unknown";

          monthTotals[month] = (monthTotals[month] || 0) + 1;

          genderMonth[month] = genderMonth[month] || {};
          genderMonth[month][gender] = (genderMonth[month][gender] || 0) + 1;

          ageDist[ageGrp] = (ageDist[ageGrp] || 0) + 1;

          CONDITION_COLS.forEach(c => {
              if ((r[c] || "").toLowerCase() === "yes") condCnt[c]++;
          });
      });

      // 1 – total per month
      const months = Object.keys(monthTotals).sort();
      Plotly.newPlot("chart-month", [{
          type: "bar",
          x: months,
          y: months.map(m => monthTotals[m])
      }], {title: "Total Consultations per Month"});

      // 2 – gender stacked
      const genders = [...new Set(Object.values(genderMonth).flatMap(o => Object.keys(o)))];
      Plotly.newPlot("chart-gender",
          genders.map(g => ({
              name: g,
              type: "bar",
              x: months,
              y: months.map(m => (genderMonth[m] && genderMonth[m][g]) || 0)
          })),
          {title: "Consultations by Gender per Month", barmode: "stack"});

      // 3 – age distribution
      const ages = Object.keys(ageDist).sort();
      Plotly.newPlot("chart-age", [{
          type: "bar",
          x: ages,
          y: ages.map(a => ageDist[a])
      }], {title: "Age Group Distribution (All Months)"});

      // 4 – top 5 conditions
      const top5 = Object.entries(condCnt).sort((a,b)=>b[1]-a[1]).slice(0,5);
      Plotly.newPlot("chart-cond", [{
          type: "bar",
          x: top5.map(t => t[0]),
          y: top5.map(t => t[1])
      }], {title: "Top 5 Reported Conditions"});
  })
  .catch(e => { error("Data load failed: " + e.message); console.error(e); });
</script>
</body>
</html>

